<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <title>Uwspółcześniona Biblia Gdańska</title>
    <style>
     body {
         font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
     }
     .books {
         display: flex;
         flex-direction: column;
         flex-wrap: wrap;
         height: 210px;
         margin: 0;
         padding: 0;
         list-style-type: none;
         overflow: hidden;
     }

     .books li {
         margin: 0 3px;
         height: 35px;
         font-size: 30px;
         display: block;
     }
     
     .chapters {
         display: none;
         list-style-type: none;
         margin: 0;
         padding: 0;
     }
     
     .chapters li {
         height: 35px;
         font-size: 30px;
         display: block;
         float: left;
         width: 70px;
         border: solid 1px;
         text-align: center;
     }
     
     .books a, .chapters a {
         text-decoration: none;
     }
     .chapters {
         overflow: hidden;
     }

     .chapters-menu {
         justify-content: space-between;
     }

     .chapters-menu .book-name {
         font-weight: bold;
     }

     .content p {
         padding: 2px;
         margin: 3px 0;
     }
     
     .content p.active {
         background-color: #fffc8566;
         border-radius: 5px;
     }

     @media (max-width: 700px) {
         .books {
             height: 120px;
         }
         .books li {
             font-size: 15px;
             height: 20px;
         }
         .chapters li {
             font-size: 15px;
             height: 20px;
             width: 40px;
         }
     }
    </style>
  </head>
  <body>
    <ul class="books">
      {% for book in books %}
        <li>
          <a href="/{{ book.encoded_name }}/1"
             title="{{ book.full_name }}"
             nof-chapters="{{ book.nof_chapters }}"
             encoded-name="{{ book.encoded_name }}">
            {{ book.short_name }}
          </a>
        </li>
      {% endfor %}
    </ul>

    <div class="chapters-menu">
      <a href="" class="back-button">&laquo; back</a>
      <span class="book-name">{{ chapter.book_name }}}}</span>
    </div>
    
    <ul class="chapters"></ul>

    <div class="content">
      <h3>{{ chapter.book_name }}, rozdział {{ chapter.number }}</h3>
      
      {% for verse in chapter.verses %}
        <p verse-number="{{ verse.number }}">
          {{ verse.number }} {{ verse.text }}
        </p>
      {% endfor %}
    </div>

    <script>
     (function () {
         var booksContainer = document.querySelector('.books');
         var chaptersMenu = document.querySelector('.chapters-menu');
         var chaptersContainer = document.querySelector('.chapters');
         var versesContainer = document.querySelector('.content');

         function showBooksUI() {
             chaptersMenu.style.display = 'none';
             chaptersContainer.style.display = 'none';
             booksContainer.style.display = 'flex';
         }

         function showChaptersUI() {
             chaptersContainer.style.display = 'block';
             chaptersMenu.style.display = 'flex';
             booksContainer.style.display = 'none';
         }

         function selectVerse(verseNode) {
             versesContainer.querySelectorAll('p').forEach(function (p) {
                 p.className = '';
             });
             verseNode.className = 'active';
         }
         
         showBooksUI();

         if (location.hash) {
             var foundVerse = versesContainer.querySelector('[verse-number="' + location.hash.substr(1) + '"]');
             if (foundVerse) {
                 window.scrollTo(0, foundVerse.offsetTop);
                 selectVerse(foundVerse);
             }
         }
         
         chaptersMenu.querySelector('.back-button').addEventListener('click', function (event) {
             event.preventDefault();
             history.back();
         });
         
         window.addEventListener('popstate', function (event) {
             var state = event.state;
             
             if (state && state.bookName) {
                 showChapter(state.bookName, state.encodedName, state.nofChapters);
             } else {
                 showBooksUI();
             }
         });

         function showChapter(bookName, encodedName, nofChapters) {
             chaptersMenu.querySelector('.book-name').innerText = bookName;
             
             while (chaptersContainer.hasChildNodes()) {
                 chaptersContainer.removeChild(chaptersContainer.lastChild);
             }
             
             for (var i = 1; i < nofChapters + 1; i += 1) {
                 var li = document.createElement('li');
                 var a = document.createElement('a');
                 a.setAttribute('href', '/' + encodedName + '/' + i);
                 a.innerText = i;
                 li.appendChild(a);
                 chaptersContainer.appendChild(li);
             }

             showChaptersUI();
         }
         
         booksContainer.addEventListener('click', function (event) {
             if (event.target.nodeName.toLowerCase() === 'a') {
                 event.preventDefault();
                 var linkNode = event.target;
                 var bookName = linkNode.getAttribute('title') || '';
                 var encodedName = linkNode.getAttribute('encoded-name') || '';
                 var nofChapters = parseInt(linkNode.getAttribute('nof-chapters'), 10);

                 history.pushState({
                     bookName: bookName,
                     nofChapters: nofChapters,
                     encodedName: encodedName
                 }, '', '');

                 showChapter(bookName, encodedName, nofChapters);
             }
         }, true);

         versesContainer.addEventListener('click', function (event) {
             if (event.target.nodeName.toLowerCase() === 'p') {
                 event.preventDefault();
                 location.hash = event.target.getAttribute('verse-number');
                 selectVerse(event.target);
             }
         }, true);
     }());
    </script>
    
  </body>
</html>
